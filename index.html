<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Komorebi OS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <!-- SUPABASE SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ICONS -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåø</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%230e2016%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>üåø</text></svg>">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root {
      --komorebi-mint: #66c5a5;
      --komorebi-mint-soft: #7ed6b7;
      --bg-deep: #050f0a;
      --bg-forest: #08150e;
      --card: #0e2016;
      --card-soft: #13271c;
      --accent-gold: #f5c15c;
      --accent-gold-soft: rgba(245, 193, 92, 0.14);
      --accent-gold-strong: #ffdf8f;
      --text-main: #f5f7f4;
      --text-muted: #a5b4ac;
      --border-subtle: #1f3125;
      --danger: #f97373;
      --success: #4ade80;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(to bottom, var(--komorebi-mint) 0, var(--bg-forest) 140px, var(--bg-deep) 100%);
      color: var(--text-main); 
      min-height: 100vh;
    }

    /* WRAPPER */
    .container { 
        max-width: 1200px; 
        margin: 0 auto; 
        padding-top: env(safe-area-inset-top);
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        padding-bottom: 40px;
    }

    /* HEADER */
    .app-header { 
      display: flex; justify-content: space-between; align-items: flex-start; 
      padding-top: 0.5rem; padding-bottom: 0.5rem; 
      border-bottom: 1px solid rgba(0, 0, 0, 0.2); margin-bottom: 0.5rem;
    }
    .app-title { font-size: 1.5rem; font-weight: 800; text-transform: uppercase; text-shadow: 0 2px 10px rgba(102, 197, 165, 0.3); line-height: 1; margin-bottom: 2px; }
    .app-subtitle { font-size: 0.7rem; color: var(--text-main); opacity: 0.8; }
    .header-controls { display: flex; flex-direction: column; align-items: flex-end; gap: 0.3rem; }
    #date-input { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; padding: 0.2rem 0.4rem; color: var(--text-main); font-family: inherit; font-size: 0.8rem; color-scheme: dark; text-align: right; }
    .xp-pill { font-size: 0.8rem; color: var(--accent-gold-strong); font-weight: 700; }

    /* SUMMARY */
    .summary-bar { background: rgba(6, 19, 13, 0.9); border-radius: 10px; padding: 0.4rem 0.6rem; border: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; backdrop-filter: blur(10px); }
    .summary-left { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; }
    #total-xp { font-weight: 600; }
    .badge { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
    .elite { background: rgba(74, 222, 128, 0.2); color: #4ade80; border: 1px solid rgba(74, 222, 128, 0.4); }
    .strong { background: rgba(96, 165, 250, 0.2); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.4); }
    .survival { background: rgba(250, 204, 21, 0.2); color: #facc15; border: 1px solid rgba(250, 204, 21, 0.4); }
    .red { background: rgba(248, 113, 113, 0.2); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.4); }
    .summary-actions { display: flex; gap: 0.3rem; }
    
    button { background: var(--accent-gold); color: #0e2016; border: none; border-radius: 6px; padding: 0.3rem 0.7rem; font-size: 0.8rem; font-weight: 700; cursor: pointer; }
    button.secondary { background: transparent; border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-muted); }
    button.icon-btn { padding: 0.3rem 0.5rem; min-width: 30px; }
    button.danger { background: rgba(249, 115, 115, 0.15); color: var(--danger); border: 1px solid var(--danger); }
    button.add-btn { width: 100%; margin-top: 0.5rem; background: rgba(255,255,255,0.05); color: var(--komorebi-mint); border: 1px dashed var(--border-subtle); padding: 0.5rem; }
    button.tiny-btn { padding: 0.2rem 0.4rem; font-size: 0.7rem; margin-left: 2px;}

    /* CARDS */
    .section-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: rgba(255, 255, 255, 0.5); margin: 0 0 0.3rem 0.2rem; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
    @media (max-width: 768px) { .grid-3, .grid-2 { grid-template-columns: 1fr; } }
    
    .card { background: var(--card); border-radius: 10px; padding: 0.7rem; border: 1px solid var(--border-subtle); display: flex; flex-direction: column; gap: 0.4rem; position: relative; overflow: hidden; }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; z-index: 1; }
    .card-title { font-size: 0.9rem; font-weight: 700; color: #fff; }
    .xp-display { font-size: 0.7rem; color: var(--accent-gold); font-weight: 600; background: rgba(245, 193, 92, 0.1); padding: 2px 6px; border-radius: 4px; }
    .progress-track { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: rgba(0,0,0,0.3); }
    .progress-fill { height: 100%; background: var(--komorebi-mint); width: 0%; transition: width 0.4s ease; }
    .progress-fill.maxed { background: var(--accent-gold); }
    
    .items { display: grid; gap: 0.3rem; z-index: 1; }
    label { display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer; font-size: 0.85rem; line-height: 1.3; color: var(--text-muted); transition: color 0.2s; }
    label:hover { color: var(--text-main); }
    input[type="checkbox"] { accent-color: var(--accent-gold); transform: scale(1.1); margin-top: 2px; cursor: pointer; }
    
    /* DROPDOWNS */
    details.details-list { margin-top: 0.2rem; font-size: 0.75rem; color: var(--text-muted); margin-left: 1.5rem; }
    details.details-list summary { cursor: pointer; list-style: none; outline: none; opacity: 0.7; }
    details.details-list summary:hover { opacity: 1; }
    .sub-list { margin: 0.3rem 0 0; padding-left: 0.5rem; border-left: 1px solid var(--border-subtle); }
    .sub-list li { list-style: none; margin-bottom: 0.2rem; }

    .prompt-body { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; }
    .prompt-body b { color: var(--text-main); }
    .investor-meta { font-size: 0.7rem; background: rgba(255,255,255,0.1); padding: 0.1rem 0.4rem; border-radius: 4px; color: var(--accent-gold); margin-top: 0.3rem; display: inline-block; }

    /* MODALS */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 50; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-content { background: var(--card); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--accent-gold); max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; color: var(--accent-gold); font-size: 1.1rem; font-weight: 700; border-bottom: 1px solid var(--border-subtle); padding-bottom: 0.5rem; }
    
    /* EDITOR STYLES */
    .editor-section { margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .editor-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; flex-wrap: wrap; }
    .editor-input { background: rgba(0,0,0,0.3); border: 1px solid var(--border-subtle); color: var(--text-main); padding: 0.5rem; border-radius: 6px; flex: 1; min-width: 120px; font-family: inherit; font-size: 0.85rem; }
    .editor-input-sm { width: 70px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-subtle); color: var(--text-main); padding: 0.5rem; border-radius: 6px; text-align: center; }
    .editor-label { font-size: 0.75rem; color: var(--komorebi-mint); margin-bottom: 0.5rem; display: block; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
    
    .item-edit-container { margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.02); border-radius: 6px; display: flex; gap: 0.5rem; align-items: center; }
    .item-edit-inputs { flex: 1; display: flex; flex-direction: column; gap: 0.3rem; }
    .item-edit-actions { display: flex; flex-direction: column; gap: 0.3rem; }

    .lib-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; overflow-x: auto; padding-bottom: 0.5rem; scrollbar-width: none; }
    .lib-tabs::-webkit-scrollbar { display: none; }
    .lib-tab { cursor: pointer; padding: 0.4rem 0.8rem; font-size: 0.85rem; color: var(--text-muted); border-radius: 6px; white-space: nowrap; background: rgba(255,255,255,0.05); transition: all 0.2s; }
    .lib-tab.active { background: var(--komorebi-mint); color: #050f0a; font-weight: 700; }
    .lib-item { background: rgba(255,255,255,0.03); padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid transparent; transition: border-color 0.2s; }
    .lib-item:hover { border-color: var(--komorebi-mint-soft); }
    .lib-title { color: var(--komorebi-mint); font-weight: 700; font-size: 0.95rem; margin-bottom: 0.2rem;}
    .lib-desc { color: var(--text-muted); font-size: 0.85rem; line-height: 1.4; }

    /* ANIMATION */
    .floating-xp { position: fixed; color: var(--accent-gold); font-weight: bold; font-size: 1rem; pointer-events: none; animation: floatUp 1s ease-out forwards; z-index: 9999; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) } 100% { opacity: 0; transform: translateY(-40px) } }
    
    textarea { width: 100%; height: 100px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); border-radius: 8px; color: #fff; padding: 0.8rem; font-family: inherit; line-height: 1.5; }
    
    /* KNOWLEDGE DB STYLES */
    .db-entry { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <canvas id="confetti-canvas"></canvas>

  <div class="container">
    <header class="app-header">
      <div class="app-title-block">
        <div class="app-title">Komorebi OS</div>
        <div class="app-subtitle">Master Protocol</div>
      </div>
      <div class="header-controls">
        <div class="xp-pill"><span id="xp-pill-value">0</span> XP</div>
        <input type="date" id="date-input" />
      </div>
    </header>

    <section class="summary-bar">
      <div class="summary-left">
        <span id="total-xp">Total: 0</span>
        <span id="day-rating" class="badge red">Red Zone</span>
      </div>
      <div class="summary-actions">
        <button id="save-day" onclick="saveDay()">Save</button>
        <button id="cloud-btn" class="secondary icon-btn" title="Cloud Sync" onclick="cloudSync()">‚òÅÔ∏è</button>
        <button class="secondary icon-btn" title="Library" onclick="openLibrary()">üìñ</button>
        <button class="secondary icon-btn" title="Stats" onclick="renderStats()">üìä</button>
        <button class="secondary icon-btn" title="Customize" onclick="openEditor()">‚úèÔ∏è</button>
      </div>
    </section>

    <div id="app-content"></div>
  </div>

  <!-- CUSTOMIZE MODAL -->
  <div class="modal-overlay" id="editor-modal">
      <div class="modal-content">
          <div class="modal-header">
              Customize 
              <div>
                  <button onclick="factoryReset()" class="danger" style="font-size:0.7rem; padding:0.2rem 0.5rem; margin-right:10px;">Reset</button>
                  <span style="cursor:pointer" onclick="closeModal('editor-modal')">‚úï</span>
              </div>
          </div>
          <div class="lib-tabs">
              <div class="lib-tab active" onclick="switchEditorTab('protocols')">Protocols</div>
              <div class="lib-tab" onclick="switchEditorTab('workouts')">Workouts</div>
              <div class="lib-tab" onclick="switchEditorTab('library')">Library</div>
              <div class="lib-tab" onclick="switchEditorTab('knowledge')">Add Docs</div>
          </div>
          <div id="editor-content"></div>
          <div class="modal-actions">
              <button onclick="saveCustomConfig()">Save Changes</button>
          </div>
      </div>
  </div>

  <!-- LIBRARY MODAL -->
  <div class="modal-overlay" id="library-modal">
    <div class="modal-content">
      <div class="modal-header">Knowledge Base <span style="cursor:pointer" onclick="closeModal('library-modal')">‚úï</span></div>
      <div class="lib-tabs">
        <div class="lib-tab active" onclick="switchLibTab('mentalModels')">Models</div>
        <div class="lib-tab" onclick="switchLibTab('productivity')">Productivity</div>
        <div class="lib-tab" onclick="switchLibTab('investors')">Investors</div>
        <div class="lib-tab" onclick="switchLibTab('quotes')">Quotes</div>
        <div class="lib-tab" onclick="switchLibTab('docs')">My Docs</div>
      </div>
      <input type="text" id="lib-search" class="search-bar" placeholder="Search..." onkeyup="renderLibrary()">
      <div id="library-list"></div>
    </div>
  </div>

  <!-- STATS MODAL -->
  <div class="modal-overlay" id="stats-modal">
    <div class="modal-content">
      <div class="modal-header">Performance <span style="cursor:pointer" onclick="closeModal('stats-modal')">‚úï</span></div>
      <div class="chart-container" id="stats-chart"></div>
    </div>
  </div>

  <script>
    // --- SUPABASE CONFIG ---
    const SUPABASE_URL = 'https://gzxnrhxswleubryhemyz.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6eG5yaHhzd2xldWJyeWhlbXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MTQ4ODQsImV4cCI6MjA3OTE5MDg4NH0.nMI1TZ1oRz_5aq_Oyp0xWxx_T8-SUWloYEaxNQagJxs';
    
    let supabaseClient;
    if (typeof supabase !== 'undefined') {
        try { supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { console.log("Supabase init skipped"); }
    }

    // ==========================================
    // 1. DEFAULT CONFIGURATION
    // ==========================================
    const DEFAULT_CONFIG = {
        levels: { elite: 6500, strong: 5000, survival: 3500 },
        maxXP: 9000,
        library: {
            mentalModels: [
                { name: "First Principles Thinking", desc: "Reduce problems to fundamental truths, build upward." },
                { name: "Second-Order Thinking", desc: "Consider consequences beyond the immediate." },
                { name: "Inversion", desc: "Think backward: how could this fail? Then avoid it." },
                { name: "Probabilistic Thinking", desc: "Evaluate decisions using likelihoods, not certainties." },
                { name: "Bayesian Updating", desc: "Adjust beliefs in light of new evidence." },
                { name: "Expected Value", desc: "Quantify decisions: outcomes √ó probabilities." },
                { name: "Circle of Competence", desc: "Operate within your area of true knowledge." },
                { name: "Occam‚Äôs Razor", desc: "Prefer the simplest explanation that fits the data." },
                { name: "Hanlon‚Äôs Razor", desc: "Never attribute to malice what can be explained by stupidity." },
                { name: "Pareto Principle", desc: "80% of effects come from 20% of causes." },
                { name: "Compound Effect", desc: "Small, smart choices + consistency + time = radical difference." },
                { name: "Anti-fragility", desc: "Seek systems that benefit from disorder." }
            ],
            productivity: [
                { name: "5 Second Rule", desc: "Count 5-4-3-2-1-GO to bypass hesitation." },
                { name: "Eat That Frog", desc: "Do the biggest, ugliest task first thing." },
                { name: "2-Minute Rule", desc: "If it takes < 2 mins, do it now." },
                { name: "Time Boxing", desc: "Schedule every minute of your day." },
                { name: "Deep Work", desc: "Dedicate blocks of time to distraction-free cognitive work." },
                { name: "Pomodoro", desc: "25 min focus, 5 min diffuse mode." },
                { name: "The One Thing", desc: "What is the one thing that makes everything else easier?" }
            ],
            investors: [
                { name: "Stanley Druckenmiller", resource: "The Genius of Stan Druckenmiller", years: "30 Years" },
                { name: "Warren Buffett", resource: "Berkshire Shareholder Letters", years: "55 Years" },
                { name: "Charlie Munger", resource: "Poor Charlie's Almanack", years: "15+ Years" },
                { name: "Seth Klarman", resource: "Margin of Safety", years: "25 Years" },
                { name: "Howard Marks", resource: "The Most Important Thing", years: "25+ Years" },
                { name: "Ray Dalio", resource: "Principles", years: "40 Years" },
                { name: "Naval Ravikant", resource: "The Almanack of Naval Ravikant", years: "Angel" }
            ],
            quotes: [
                "‚ÄúDiscipline equals freedom.‚Äù ‚Äî Jocko Willink",
                "‚ÄúThe impediment to action advances action.‚Äù ‚Äî Marcus Aurelius",
                "‚ÄúThe score takes care of itself.‚Äù ‚Äî Bill Walsh",
                "‚ÄúHe who has a why to live can bear almost any how.‚Äù ‚Äî Nietzsche",
                "‚ÄúAction isn't just the effect of motivation; it's also the cause of it.‚Äù ‚Äî Mark Manson",
                "‚ÄúSlow is smooth, smooth is fast.‚Äù ‚Äî Navy SEALs",
                "‚ÄúInvert, always invert.‚Äù ‚Äî Jacobi",
                "‚ÄúTo get what you want, you have to deserve what you want.‚Äù ‚Äî Charlie Munger"
            ]
        },
        protocols: [
            {
                id: "health",
                title: "Health",
                columns: 3,
                cards: [
                    {
                        id: "supplements",
                        title: "Supplement Stack",
                        maxXP: 500,
                        scoringType: "count_multiplier",
                        perItemXP: 500,
                        items: [ { id: "supplementStack", label: "Stack complete" } ],
                        details: ["Electrolytes", "Alpha GPC", "Omega 3", "Flexi-Calcium", "Joint Complex"]
                    },
                    {
                        id: "smoothie",
                        title: "Supersmoothie",
                        maxXP: 500,
                        scoringType: "count_multiplier",
                        perItemXP: 500,
                        items: [ { id: "smoothie", label: "Smoothie complete" } ],
                        details: ["Clean Protein 35g", "Creatine 5g", "Greens powder", "Berries", "Turmeric/Ginger"]
                    },
                    {
                        id: "fitness",
                        title: "Fitness & Recovery",
                        maxXP: 1000,
                        scoringType: "count_multiplier", 
                        perItemXP: 334,
                        items: [
                            { id: "sunshine", label: "Sunshine" },
                            { id: "rollerYoga", label: "Roller / Yoga" },
                            { id: "protein120", label: "Protein ‚â• 120g" },
                            { id: "exercise", label: "Exercise" },
                            { id: "cold", label: "Cold / sauna" }
                        ]
                    }
                ]
            },
            {
                id: "mind",
                title: "Mind & Arete",
                columns: 3,
                cards: [
                    {
                        id: "wisdom",
                        title: "Wisdom & Clarity",
                        maxXP: 1000,
                        scoringType: "count_multiplier",
                        perItemXP: 250,
                        items: [
                            { id: "gratitude", label: "Gratitude" },
                            { id: "journal", label: "Journal" },
                            { id: "meditate", label: "Meditate" },
                            { id: "mentalModel", label: "Mental model" }
                        ]
                    },
                    {
                        id: "arete",
                        title: "Arete & Alignment",
                        maxXP: 1000,
                        scoringType: "count_multiplier",
                        perItemXP: 500,
                        items: [
                            { id: "familyTime", label: "Family time" },
                            { id: "golf", label: "Golf / Skill" },
                            { id: "fiction", label: "Read fiction" },
                            { id: "contribution", label: "Contribution" }
                        ]
                    },
                    {
                        id: "values",
                        title: "Values",
                        maxXP: 1000,
                        scoringType: "count_multiplier",
                        perItemXP: 334,
                        items: [
                            { id: "valueCourage", label: "Courage" },
                            { id: "valueDiscipline", label: "Discipline" },
                            { id: "valueKindness", label: "Kindness" }
                        ]
                    }
                ]
            },
            {
                id: "craft",
                title: "Craft & Duty",
                columns: 2,
                cards: [
                    {
                        id: "mastery",
                        title: "Mastery",
                        maxXP: 2000,
                        scoringType: "count_multiplier",
                        perItemXP: 666,
                        items: [
                            { id: "investingReading", label: "Deep Reading" },
                            { id: "researchMemo", label: "Deep Work Block" },
                            { id: "investorInteraction", label: "Networking" }
                        ]
                    },
                    {
                        id: "responsibility",
                        title: "Responsibility",
                        maxXP: 2000,
                        scoringType: "count_multiplier",
                        perItemXP: 666,
                        items: [
                            { id: "earnIncome", label: "Earn income" },
                            { id: "completeTaxes", label: "Admin" },
                            { id: "hectorBellaEducation", label: "Education" }
                        ]
                    }
                ]
            }
        ],
        workouts: [
            { t: "Sunday", d: "Endurance/Cardio (Swim, Hike, Long Zone 2)" },
            { t: "Monday", d: "Lower Body Strength (Squat/Deadlift, Posterior Chain)" },
            { t: "Tuesday", d: "Sauna + Cold Exposure (3-5 Rounds)" },
            { t: "Wednesday", d: "Upper Body Strength (Push/Pull, Delts)" },
            { t: "Thursday", d: "Cardio Endurance (Row/Ski/Run/Bike/Ruck)" },
            { t: "Friday", d: "HIIT (Bike, Row, Sled, KB Swings - No Burpees)" },
            { t: "Saturday", d: "Hypertrophy (Arms, Core, Calves, Neck)" }
        ]
    };

    // --- GLOBAL STATE ---
    let APP_CONFIG = {};
    let currentLibTab = 'mentalModels';
    let currentEditorTab = 'protocols';
    let currentUser = null;

    // --- INITIALIZATION ---
    async function init() {
        const savedConfig = localStorage.getItem('komorebi_custom_config');
        if (savedConfig) {
            APP_CONFIG = JSON.parse(savedConfig);
        } else {
            APP_CONFIG = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
        }

        document.getElementById('date-input').value = new Date().toISOString().slice(0, 10);
        renderApp();
        loadDay();
        
        document.getElementById('date-input').addEventListener('change', loadDay);
        
        if (supabaseClient) checkUser();
    }
    
    async function checkUser() {
        const { data } = await supabaseClient.auth.getSession();
        if (data.session) {
            currentUser = data.session.user;
            document.getElementById('cloud-btn').innerText = "‚òÅÔ∏è‚úî";
        }
    }

    // --- CLOUD SYNC ---
    async function cloudSync() {
        if (!supabaseClient) return alert("Supabase not initialized.");
        
        if (!currentUser) {
            // Google Login
            const { data, error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: window.location.href }
            });
            if (error) alert("Login Error: " + error.message);
        } else {
            await saveToCloud();
        }
    }

    async function saveToCloud() {
        if (!currentUser) return;
        const history = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('komorebi_')) {
                history[key] = JSON.parse(localStorage.getItem(key));
            }
        }
        const payload = {
            user_id: currentUser.id,
            data: { config: APP_CONFIG, history: history },
            updated_at: new Date()
        };
        const { error } = await supabaseClient.from('user_data').upsert(payload, { onConflict: 'user_id' });
        if (error) alert("Sync Failed: " + error.message);
        else {
            document.getElementById('cloud-btn').innerText = "‚òÅÔ∏è‚úî";
            alert("Synced to Cloud ‚úÖ");
        }
    }
    
    // --- MANUAL DOCUMENT UPLOAD ---
    async function saveDocument() {
        if(!currentUser) return alert("Please log in (Cloud Button) to save docs.");
        const title = document.getElementById('doc-title').value;
        const body = document.getElementById('doc-body').value;
        if(!title || !body) return alert("Enter title and content");
        
        // Simple Insert to Supabase 'documents' table
        const { error } = await supabaseClient.from('documents').insert({
            content: title + "\n\n" + body,
            metadata: { title: title, source: "Manual Entry" }
        });
        
        if(error) alert("Error saving doc: " + error.message);
        else {
            alert("Saved to Brain!");
            document.getElementById('doc-title').value = "";
            document.getElementById('doc-body').value = "";
        }
    }
    
    async function loadMyDocs() {
        if(!currentUser) return [];
        const { data, error } = await supabaseClient.from('documents').select('*').order('id', { ascending: false }).limit(20);
        if(error) return [];
        return data;
    }

    // --- RENDER APP ---
    function renderApp() {
        const seed = document.getElementById('date-input').value;
        
        const model = getRandom(APP_CONFIG.library.mentalModels, seed + 'm');
        const prod = getRandom(APP_CONFIG.library.productivity, seed + 'p');
        const quote = getRandom(APP_CONFIG.library.quotes, seed + 'q');
        const inv = getInvestorOfTheWeek(seed);

        let html = `
        <section class="section-block">
          <h2 class="section-title">Daily Alignment</h2>
          <div class="grid-2">
            <div class="card"><div class="card-header"><div class="card-title">Mental Model</div></div><div class="prompt-body"><b>${model.name}</b><br>${model.desc}</div></div>
            <div class="card"><div class="card-header"><div class="card-title">Productivity</div></div><div class="prompt-body"><b>${prod.name}</b><br>${prod.desc}</div></div>
            <div class="card"><div class="card-header"><div class="card-title">Wisdom</div></div><div class="prompt-body">${quote.name ? quote.desc : quote}</div></div>
            <div class="card" style="border-color:var(--komorebi-mint-soft)">
                <div class="card-header"><div class="card-title">Investor of the Week</div><div class="xp-display">Weekly</div></div>
                <div class="prompt-body">
                    <div style="color:var(--komorebi-mint); font-weight:700">${inv.name}</div>
                    <div style="font-style:italic">${inv.resource}</div>
                    <div class="investor-meta">${inv.years}</div>
                </div>
            </div>
          </div>
        </section>`;

        APP_CONFIG.protocols.forEach(section => {
            html += `<section class="section-block"><h2 class="section-title">${section.title}</h2><div class="grid-${section.columns}">`;
            section.cards.forEach(card => {
                html += `
                <div class="card" id="card-${card.id}">
                    <div class="card-header">
                        <div class="card-title">${card.title}</div>
                        <div class="xp-display">0 / ${card.maxXP} XP</div>
                    </div>
                    <div class="progress-track"><div class="progress-fill"></div></div>
                    <div class="items">`;
                card.items.forEach(item => {
                    let xpVal = card.scoringType === 'count_multiplier' ? card.perItemXP : (item.xp || card.maxXP);
                    html += `<label><input type="checkbox" data-key="${item.id}" data-card="${card.id}" data-xp="${xpVal}"> ${item.label}</label>`;
                });
                
                if (card.details && card.details.length > 0) {
                    html += `<details class="details-list"><summary>View Details</summary><ul class="sub-list">`;
                    card.details.forEach(d => html += `<li>${d}</li>`);
                    html += `</ul></details>`;
                }
                html += `</div></div>`;
            });
            html += `</div></section>`;
        });

        const dateObj = new Date(seed);
        const dayIdx = dateObj.getDay();
        const w = APP_CONFIG.workouts && APP_CONFIG.workouts[dayIdx] ? APP_CONFIG.workouts[dayIdx] : { t: "Rest", d: "Recover" };
        html += `
        <section class="section-block">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Workout of the Day</div>
                <div style="font-size:0.8rem; color:var(--text-muted)">${w.t}</div>
              </div>
              <div class="items" style="font-size:0.85rem; color:var(--text-main)">${w.d}</div>
            </div>
        </section>`;

        html += `<section class="section-block"><div class="card"><div class="card-header"><div class="card-title">Daily Journal</div></div><textarea id="daily-note-area" placeholder="Wins, lessons, or thoughts..."></textarea></div></section>`;

        document.getElementById('app-content').innerHTML = html;

        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', (e) => {
                updateVisuals();
                if(e.target.checked) showFloatingXP(e);
            });
        });
    }

    // --- EDITOR ENGINE ---
    function openEditor() { openModal('editor-modal'); renderEditorContent(); }
    function switchEditorTab(tab) {
        currentEditorTab = tab;
        document.querySelectorAll('#editor-modal .lib-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        renderEditorContent();
    }
    function renderEditorContent() {
        const container = document.getElementById('editor-content');
        container.innerHTML = '';
        if (currentEditorTab === 'protocols') {
            APP_CONFIG.protocols.forEach((section, sIdx) => {
                let html = `<div class="editor-section"><div class="editor-label">${section.title}</div>`;
                section.cards.forEach((card, cIdx) => {
                    html += `<div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:10px;">
                        <div class="editor-row"><input class="editor-input" value="${card.title}" onchange="updateConfigValue('protocols', '${sIdx}.cards.${cIdx}.title', this.value)">
                        <input class="editor-input-sm" type="number" value="${card.maxXP}" onchange="updateConfigValue('protocols', '${sIdx}.cards.${cIdx}.maxXP', this.value)"> XP</div>
                        <div class="editor-label" style="font-size:0.7rem; color:#aaa">Checkboxes</div>`;
                    card.items.forEach((item, iIdx) => {
                        html += `<div class="editor-row"><input class="editor-input" value="${item.label}" onchange="updateConfigValue('protocols', '${sIdx}.cards.${cIdx}.items.${iIdx}.label', this.value)">
                        <button class="danger icon-btn" onclick="deleteProtocolItem(${sIdx}, ${cIdx}, ${iIdx})">√ó</button></div>`;
                    });
                    html += `<button onclick="addProtocolItem(${sIdx}, ${cIdx})" class="add-btn">+ Add Checkbox</button></div>`;
                });
                html += `</div>`;
                container.innerHTML += html;
            });
        } else if (currentEditorTab === 'workouts') {
            let html = `<div class="editor-section"><div class="editor-label">Daily Workouts</div>`;
            APP_CONFIG.workouts.forEach((w, idx) => {
                html += `<div class="editor-row"><div style="width:80px; font-size:0.8rem;">Day ${idx}</div>
                <input class="editor-input" value="${w.t}" onchange="updateConfigValue('workouts', '${idx}.t', this.value)">
                <input class="editor-input" value="${w.d}" onchange="updateConfigValue('workouts', '${idx}.d', this.value)"></div>`;
            });
            container.innerHTML = html + `</div>`;
        } else if (currentEditorTab === 'knowledge') {
            container.innerHTML = `
            <div class="editor-section">
                <div class="editor-label">Add Manual Knowledge</div>
                <p style="font-size:0.8rem; color:#888; margin-bottom:1rem">Paste book summaries or notes here to save to your Brain.</p>
                <input id="doc-title" class="editor-input" placeholder="Title (e.g. 'Naval Ravikant Summary')" style="margin-bottom:0.5rem">
                <textarea id="doc-body" class="editor-input" placeholder="Paste content here..." style="height:150px"></textarea>
                <button onclick="saveDocument()" style="margin-top:1rem; width:100%">Save to Brain</button>
            </div>`;
        } else {
            // Library Editor
            const key = currentEditorTab; 
            let html = `<div class="editor-section"><div class="editor-label">Add New</div>
            <div class="editor-row"><input id="new-lib-1" class="editor-input" placeholder="Name / Quote">`;
            if(key !== 'quotes') html += `<input id="new-lib-2" class="editor-input" placeholder="Description / Resource">`;
            if(key === 'investors') html += `<input id="new-lib-3" class="editor-input" placeholder="Years">`;
            html += `<button onclick="addToLibrary('${key}')" class="icon-btn">+</button></div></div>`;
            
            html += `<div class="editor-label">Existing Items (${APP_CONFIG.library[key].length})</div>`;
            APP_CONFIG.library[key].forEach((item, idx) => {
                const val1 = item.name || item; 
                const val2 = item.desc || item.resource || "";
                const val3 = item.years || "";
                
                let inputs = `<input class="editor-input" value="${val1}" onchange="updateLibItem('${key}', ${idx}, 'name', this.value)">`;
                if(key !== 'quotes') inputs += `<input class="editor-input" value="${val2}" onchange="updateLibItem('${key}', ${idx}, 'desc', this.value)">`;
                if(key === 'investors') inputs += `<input class="editor-input" style="max-width:80px" value="${val3}" onchange="updateLibItem('${key}', ${idx}, 'years', this.value)">`;

                html += `<div class="item-edit-container">
                    <div class="item-edit-actions">
                        <button class="tiny-btn" onclick="moveLibItem('${key}', ${idx}, -1)">‚Üë</button>
                        <button class="tiny-btn" onclick="moveLibItem('${key}', ${idx}, 1)">‚Üì</button>
                    </div>
                    <div class="item-edit-inputs">${inputs}</div>
                    <button class="danger icon-btn" onclick="deleteLibItem('${key}', ${idx})">√ó</button>
                </div>`;
            });
            container.innerHTML = html;
        }
    }

    function updateConfigValue(root, path, value) {
        let parts = path.split('.'); let obj = APP_CONFIG[root];
        for(let i=0; i<parts.length-1; i++) obj = obj[parts[i]];
        obj[parts[parts.length-1]] = value;
    }
    function updateLibItem(key, idx, field, value) {
        if (key === 'quotes') {
            APP_CONFIG.library[key][idx] = value;
        } else {
            if(field === 'desc' && key === 'investors') field = 'resource';
            APP_CONFIG.library[key][idx][field] = value;
        }
    }
    function moveLibItem(key, idx, dir) {
        const arr = APP_CONFIG.library[key];
        if ((dir === -1 && idx > 0) || (dir === 1 && idx < arr.length - 1)) {
            const temp = arr[idx];
            arr[idx] = arr[idx + dir];
            arr[idx + dir] = temp;
            renderEditorContent();
        }
    }
    function addProtocolItem(sIdx, cIdx) {
        APP_CONFIG.protocols[sIdx].cards[cIdx].items.push({ id: "custom_" + Date.now(), label: "New Habit" });
        renderEditorContent();
    }
    function deleteProtocolItem(sIdx, cIdx, iIdx) {
        if(confirm("Delete?")) { APP_CONFIG.protocols[sIdx].cards[cIdx].items.splice(iIdx, 1); renderEditorContent(); }
    }
    function deleteLibItem(key, idx) {
        if(confirm("Delete?")) { APP_CONFIG.library[key].splice(idx, 1); renderEditorContent(); }
    }
    function addToLibrary(key) {
        const f1 = document.getElementById(`new-lib-1`).value;
        if(!f1) return;
        
        let newItem;
        if(key === 'quotes') newItem = f1;
        else if (key === 'investors') {
             const f2 = document.getElementById(`new-lib-2`).value;
             const f3 = document.getElementById(`new-lib-3`).value;
             newItem = { name: f1, resource: f2, years: f3 };
        } else {
             const f2 = document.getElementById(`new-lib-2`).value;
             newItem = { name: f1, desc: f2 };
        }
        APP_CONFIG.library[key].unshift(newItem); 
        alert("Added!"); renderEditorContent();
    }
    function saveCustomConfig() {
        localStorage.setItem('komorebi_custom_config', JSON.stringify(APP_CONFIG));
        saveToCloud();
        closeModal('editor-modal'); renderApp(); updateVisuals(); alert("Configuration Saved!");
    }
    function factoryReset() {
        if(confirm("Reset to defaults?")) { localStorage.removeItem('komorebi_custom_config'); location.reload(); }
    }

    // --- CALCULATIONS ---
    function updateVisuals() {
        const state = readState();
        let totalXP = 0;
        APP_CONFIG.protocols.forEach(section => {
            section.cards.forEach(card => {
                let cardXP = 0;
                const checkedCount = card.items.filter(i => state[i.id]).length;
                if (card.scoringType === 'count_multiplier') {
                    if (checkedCount === card.items.length) cardXP = card.maxXP;
                    else cardXP = checkedCount * card.perItemXP;
                } else {
                    card.items.forEach(i => { if(state[i.id]) cardXP += (i.xp || 0); });
                }
                if (cardXP > card.maxXP) cardXP = card.maxXP;
                totalXP += cardXP;
                const cardEl = document.getElementById(`card-${card.id}`);
                if (cardEl) {
                    cardEl.querySelector('.xp-display').innerText = `${Math.round(cardXP)} / ${card.maxXP} XP`;
                    const pct = (cardXP / card.maxXP) * 100;
                    const fill = cardEl.querySelector('.progress-fill');
                    fill.style.width = `${pct}%`;
                    if(pct >= 100) fill.classList.add('maxed'); else fill.classList.remove('maxed');
                }
            });
        });
        document.getElementById('total-xp').innerText = `${Math.round(totalXP)}`;
        document.querySelector('.xp-pill span').innerText = Math.round(totalXP);
        let label = "Red Zone", cls = "red";
        if (totalXP >= APP_CONFIG.levels.elite) { label = "Elite"; cls = "elite"; }
        else if (totalXP >= APP_CONFIG.levels.strong) { label = "Strong"; cls = "strong"; }
        else if (totalXP >= APP_CONFIG.levels.survival) { label = "Survival"; cls = "survival"; }
        const rating = document.getElementById('day-rating');
        rating.className = `badge ${cls}`; rating.innerText = label;
    }

    // --- LIBRARY ---
    async function renderLibrary() {
        const filter = document.getElementById('lib-search').value.toLowerCase();
        const container = document.getElementById('library-list');
        container.innerHTML = '';
        
        if(currentLibTab === 'docs') {
             // Render Docs from Cloud
             const docs = await loadMyDocs();
             if(docs.length === 0) container.innerHTML = '<div style="padding:1rem; color:#888">No documents found. Use Customize > Add Docs to save notes.</div>';
             
             docs.forEach(doc => {
                 const title = doc.metadata?.title || "Untitled";
                 if(filter && !title.toLowerCase().includes(filter) && !doc.content.toLowerCase().includes(filter)) return;
                 container.innerHTML += `<div class="lib-item"><div class="lib-title">${title}</div><div class="lib-desc" style="white-space:pre-wrap; max-height:100px; overflow:hidden">${doc.content}</div></div>`;
             });
             return;
        }

        let data = APP_CONFIG.library[currentLibTab] || [];
        if(currentLibTab === 'quotes') data = data.map(q => ({ name: "Quote", desc: q }));
        
        container.innerHTML = data.filter(i => i.name.toLowerCase().includes(filter) || (i.desc && i.desc.toLowerCase().includes(filter)))
            .map(i => `<div class="lib-item"><div class="lib-title">${i.name} ${i.years ? `<span class="investor-meta">${i.years}</span>` : ''}</div><div class="lib-desc">${i.resource || i.desc}</div></div>`).join('');
    }
    
    function switchLibTab(tab) {
        currentLibTab = tab; document.querySelectorAll('#library-modal .lib-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active'); renderLibrary();
    }
    function openLibrary() { openModal('library-modal'); renderLibrary(); }

    // --- HELPERS ---
    function readState() { const s = {}; document.querySelectorAll('input[type="checkbox"]').forEach(cb => s[cb.dataset.key] = cb.checked); return s; }
    function writeState(s) { document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = !!s[cb.dataset.key]); document.getElementById('daily-note-area').value = s.note || ""; }
    function getFormatKey() { return `komorebi_${document.getElementById('date-input').value}`; }
    function saveDay() { const s = readState(); s.note = document.getElementById('daily-note-area').value; localStorage.setItem(getFormatKey(), JSON.stringify(s)); saveToCloud(); }
    function loadDay() { renderApp(); const raw = localStorage.getItem(getFormatKey()); if(raw) writeState(JSON.parse(raw)); updateVisuals(); }
    function resetDay() { writeState({}); updateVisuals(); }
    function showFloatingXP(e) { const div = document.createElement('div'); div.className = 'floating-xp'; div.innerText = `+${e.target.dataset.xp} XP`; div.style.left = e.clientX + 'px'; div.style.top = e.clientY + 'px'; document.body.appendChild(div); setTimeout(() => div.remove(), 1000); }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function getRandom(arr, seed) { let hash = 0; for(let i=0; i<seed.length; i++) hash = ((hash << 5) - hash) + seed.charCodeAt(i); return arr[Math.abs(hash) % arr.length]; }
    function getInvestorOfTheWeek(dateStr) { const d = new Date(dateStr); const start = new Date(d.getFullYear(), 0, 1); const week = Math.ceil((((d - start) / 86400000) + start.getDay() + 1) / 7); return APP_CONFIG.library.investors[week % APP_CONFIG.library.investors.length]; }
    function openSettings() { document.getElementById('export-area').value = JSON.stringify({...localStorage}, null, 2); openModal('settings-modal'); }
    function restoreData() { try { const d = JSON.parse(document.getElementById('export-area').value); if(confirm("Overwrite?")) { localStorage.clear(); Object.keys(d).forEach(k => localStorage.setItem(k, d[k])); location.reload(); } } catch(e) { alert("Invalid JSON"); } }
    function renderStats() { const container = document.getElementById('stats-chart'); container.innerHTML = ''; const today = new Date(); for (let i=6; i>=0; i--) { const d = new Date(today); d.setDate(d.getDate() - i); const iso = d.toISOString().slice(0,10); const key = `komorebi_${iso}`; const raw = localStorage.getItem(key); let xp = 0; if (raw) { const s = JSON.parse(raw); xp = 1000; } const group = document.createElement('div'); group.className = 'bar-group'; group.innerHTML = `<div class="bar" style="height:${xp>0?50:2}%"></div><div class="bar-label">${iso.slice(5)}</div>`; container.appendChild(group); } openModal('stats-modal'); }

    init();
  </script>
</body>
</html>
