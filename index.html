<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Komorebi OS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Load your data file first -->
  <script src="komorebi-data.js"></script>

  <style>
    :root {
      --komorebi-mint: #66c5a5;
      --komorebi-mint-soft: #7ed6b7;
      --bg-deep: #050f0a;
      --bg-forest: #08150e;
      --card: #0e2016;
      --card-soft: #13271c;
      --accent-gold: #f5c15c;
      --accent-gold-soft: rgba(245, 193, 92, 0.14);
      --accent-gold-strong: #ffdf8f;
      --text-main: #f5f7f4;
      --text-muted: #a5b4ac;
      --border-subtle: #1f3125;
      --danger: #f97373;
      --success: #4ade80;
    }

    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0; padding: 0.75rem;
      background: linear-gradient(to bottom, var(--komorebi-mint) 0, var(--bg-forest) 140px, var(--bg-deep) 100%);
      color: var(--text-main); min-height: 100vh; position: relative;
    }
    .container { max-width: 1200px; margin: 0 auto; position: relative; z-index: 2; }

    /* HEADER */
    .app-header { margin-bottom: 0.4rem; padding-bottom: 0.2rem; border-bottom: 1px solid rgba(0, 0, 0, 0.2); }
    .app-header-top { display: flex; justify-content: space-between; align-items: flex-end; gap: 0.75rem; flex-wrap: wrap; }
    .app-title { font-size: 1.7rem; font-weight: 700; text-transform: uppercase; text-shadow: 0 2px 10px rgba(102, 197, 165, 0.3); }
    .app-subtitle { font-size: 0.85rem; color: var(--text-main); opacity: 0.9; }
    .header-controls { display: flex; align-items: center; gap: 0.6rem; }
    #date-input { background: rgba(0, 0, 0, 0.25); border: 1px solid rgba(0, 0, 0, 0.3); border-radius: 999px; padding: 0.35rem 0.7rem; color: var(--text-main); font-family: inherit; }
    .xp-pill { background: var(--accent-gold-soft); color: var(--accent-gold-strong); border-radius: 999px; padding: 0.3rem 0.75rem; font-size: 0.8rem; border: 1px solid rgba(245, 193, 92, 0.6); font-weight: 600; }

    /* SUMMARY BAR */
    .summary-bar {
      background: rgba(6, 19, 13, 0.9); border-radius: 12px; padding: 0.4rem 0.7rem;
      border: 1px solid rgba(0, 0, 0, 0.35); display: grid; grid-template-columns: minmax(0, 1fr) auto;
      align-items: center; gap: 0.4rem; margin-bottom: 0.6rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px);
    }
    @media (max-width: 900px) { .summary-bar { grid-template-columns: minmax(0, 1fr); } .summary-actions { justify-content: flex-start; } }
    .summary-main-top { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; font-size: 0.9rem; }
    #total-xp { font-weight: 500; }
    .badge { display: inline-block; padding: 0.1rem 0.6rem; border-radius: 999px; font-size: 0.78rem; margin-left: 0.2rem; }
    .elite { background: rgba(22, 163, 74, 0.22); color: #6ee7b7; border: 1px solid #16a34a; }
    .strong { background: rgba(37, 99, 235, 0.18); color: #93c5fd; border: 1px solid #2563eb; }
    .survival { background: rgba(234, 179, 8, 0.18); color: #fde68a; border: 1px solid #eab308; }
    .red { background: rgba(248, 113, 113, 0.2); color: #fecaca; border: 1px solid #ef4444; }
    .summary-actions { display: flex; gap: 0.4rem; }
    button { background: var(--accent-gold); color: #1f2933; border: none; border-radius: 999px; padding: 0.35rem 0.9rem; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    button:hover { filter: brightness(1.1); transform: translateY(-1px); }
    button.secondary { background: transparent; border: 1px solid rgba(148, 163, 184, 0.6); color: var(--text-main); }
    button.icon-btn { padding: 0.35rem 0.5rem; min-width: 32px; }

    /* SECTIONS & CARDS */
    .section-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.16em; color: rgba(245, 247, 244, 0.8); margin: 0.5rem 0 0.2rem; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.45rem; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.45rem; }
    @media (max-width: 768px) { .grid-3, .grid-2 { grid-template-columns: 1fr; } }
    
    .card { background: var(--card); border-radius: 12px; padding: 0.6rem 0.7rem; border: 1px solid var(--border-subtle); display: flex; flex-direction: column; gap: 0.3rem; position: relative; overflow: hidden; }
    .card-header { display: flex; justify-content: space-between; align-items: center; z-index: 1; }
    .card-title { font-size: 0.95rem; font-weight: 600; }
    .xp-display { font-size: 0.75rem; color: var(--accent-gold-strong); font-weight: 600; }
    .progress-track { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: rgba(0,0,0,0.3); }
    .progress-fill { height: 100%; background: var(--komorebi-mint); width: 0%; transition: width 0.4s ease; }
    .progress-fill.maxed { background: var(--accent-gold); }
    
    .items { display: grid; gap: 0.2rem; z-index: 1; }
    label { display: flex; align-items: center; gap: 0.4rem; cursor: pointer; font-size: 0.85rem; transition: color 0.2s; }
    label:hover { color: var(--komorebi-mint-soft); }
    input[type="checkbox"] { accent-color: var(--accent-gold); transform: scale(1.1); cursor: pointer; }

    .prompt-body { font-size: 0.9rem; color: var(--text-muted); line-height: 1.4; font-style: italic; }
    .investor-meta { font-size: 0.75rem; background: rgba(255,255,255,0.1); padding: 0.1rem 0.4rem; border-radius: 4px; color: var(--accent-gold-strong); margin-top: 0.2rem; display: inline-block; }

    /* MODALS & LIBRARY */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 50; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-content { background: var(--card); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--accent-gold); max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 1rem; color: var(--accent-gold); font-size: 1.2rem; font-weight: bold; }
    .lib-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; overflow-x: auto; border-bottom: 1px solid var(--border-subtle); padding-bottom: 0.5rem; }
    .lib-tab { cursor: pointer; padding: 0.3rem 0.6rem; font-size: 0.85rem; color: var(--text-muted); border-radius: 4px; white-space: nowrap; }
    .lib-tab.active { background: var(--komorebi-mint); color: #000; font-weight: 600; }
    .search-bar { width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--border-subtle); color: #fff; border-radius: 6px; margin-bottom: 1rem; }
    .lib-item { background: rgba(255,255,255,0.03); padding: 0.6rem; border-radius: 6px; margin-bottom: 0.5rem; }
    .lib-item-title { color: var(--komorebi-mint); font-weight: 600; font-size: 0.9rem; }
    .lib-item-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem; }

    /* Floating XP Animation */
    .floating-xp { position: fixed; color: var(--accent-gold); font-weight: bold; font-size: 1rem; pointer-events: none; animation: floatUp 1s ease-out forwards; z-index: 9999; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) } 100% { opacity: 0; transform: translateY(-40px) } }
    textarea { width: 100%; height: 80px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); border-radius: 8px; color: #fff; padding: 0.5rem; margin-top: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <header class="app-header">
      <div class="app-header-top">
        <div class="app-title-block">
          <div class="app-title">Komorebi OS</div>
          <div class="app-subtitle">Master Protocol</div>
        </div>
        <div class="header-controls">
          <input type="date" id="date-input" />
          <div class="xp-pill"><span id="xp-pill-value">0</span> XP</div>
        </div>
      </div>
    </header>

    <section class="summary-bar">
      <div class="summary-main-top">
        <span id="total-xp">Total: 0 / 9000</span>
        <span id="day-rating" class="badge red">Red Zone</span>
      </div>
      <div class="summary-actions">
        <button id="save-day">Save</button>
        <button id="library-btn" class="secondary icon-btn">üìñ</button>
        <button id="settings-btn" class="secondary icon-btn">‚öôÔ∏è</button>
        <button id="reset-day" class="secondary icon-btn">‚Ü∫</button>
      </div>
    </section>

    <!-- DYNAMIC CONTENT AREA -->
    <div id="app-content"></div>

  </div>

  <!-- LIBRARY MODAL -->
  <div class="modal-overlay" id="library-modal">
    <div class="modal-content">
      <div class="modal-header">Knowledge Library <span style="cursor:pointer" onclick="closeModal('library-modal')">‚úï</span></div>
      <div class="lib-tabs">
        <div class="lib-tab active" onclick="switchLibTab('mentalModels')">Models</div>
        <div class="lib-tab" onclick="switchLibTab('productivity')">Productivity</div>
        <div class="lib-tab" onclick="switchLibTab('investors')">Investors</div>
        <div class="lib-tab" onclick="switchLibTab('quotes')">Quotes</div>
      </div>
      <input type="text" id="lib-search" class="search-bar" placeholder="Search..." onkeyup="renderLibrary()">
      <div id="library-list"></div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="modal-overlay" id="settings-modal">
    <div class="modal-content">
      <div class="modal-header">Data Settings <span style="cursor:pointer" onclick="closeModal('settings-modal')">‚úï</span></div>
      <p style="font-size:0.8rem; color:var(--text-muted)">Backup or Restore your history.</p>
      <textarea id="export-area"></textarea>
      <div class="modal-actions">
        <button onclick="restoreData()">Restore</button>
      </div>
    </div>
  </div>

  <script>
    // --- LOGIC ENGINE ---
    const els = {
        content: document.getElementById('app-content'),
        dateInput: document.getElementById('date-input'),
        xpTotal: document.getElementById('total-xp'),
        xpPill: document.getElementById('xp-pill-value'),
        rating: document.getElementById('day-rating'),
        libList: document.getElementById('library-list')
    };

    let currentLibTab = 'mentalModels';
    let previousXP = 0;

    function init() {
        if (typeof KOMOREBI_CONFIG === 'undefined') {
            alert("Error: komorebi-data.js not found. Ensure both files are in the same folder.");
            return;
        }
        els.dateInput.value = new Date().toISOString().slice(0, 10);
        buildUI();
        loadDay();
        
        // Event Listeners
        els.dateInput.addEventListener('change', loadDay);
        document.getElementById('save-day').addEventListener('click', saveDay);
        document.getElementById('reset-day').addEventListener('click', () => { if(confirm("Reset?")) { writeState({}); updateVisuals(); }});
        document.getElementById('library-btn').addEventListener('click', () => { openModal('library-modal'); renderLibrary(); });
        document.getElementById('settings-btn').addEventListener('click', () => { 
            document.getElementById('export-area').value = JSON.stringify({...localStorage}, null, 2);
            openModal('settings-modal'); 
        });
    }

    // --- BUILDER ---
    function buildUI() {
        let html = '';

        // 1. Daily Alignment Section (Prompts)
        const seed = els.dateInput.value;
        const model = getRandom(KOMOREBI_CONFIG.library.mentalModels, seed + 'm');
        const prod = getRandom(KOMOREBI_CONFIG.library.productivity, seed + 'p');
        const quote = getRandom(KOMOREBI_CONFIG.library.quotes, seed + 'q');
        const inv = getInvestorOfTheWeek(seed);

        html += `
        <section class="section-block">
          <h2 class="section-title">Daily Alignment</h2>
          <div class="grid-2">
            <div class="card"><div class="card-header"><div class="card-title">Mental Model</div></div><div class="prompt-body"><b>${model.name}</b><br>${model.desc}</div></div>
            <div class="card"><div class="card-header"><div class="card-title">Productivity</div></div><div class="prompt-body"><b>${prod.name}</b><br>${prod.desc}</div></div>
            <div class="card"><div class="card-header"><div class="card-title">Wisdom</div></div><div class="prompt-body">${quote}</div></div>
            <div class="card" style="border-color:var(--komorebi-mint-soft)">
                <div class="card-header"><div class="card-title">Investor of the Week</div><div class="xp">Weekly</div></div>
                <div class="prompt-body">
                    <div style="color:var(--komorebi-mint); font-weight:700">${inv.name}</div>
                    <div style="font-style:italic">${inv.resource}</div>
                    <div class="investor-meta">${inv.years}</div>
                </div>
            </div>
          </div>
        </section>`;

        // 2. Protocol Sections (From Config)
        KOMOREBI_CONFIG.protocols.forEach(section => {
            html += `<section class="section-block"><h2 class="section-title">${section.title}</h2><div class="grid-${section.columns}">`;
            section.cards.forEach(card => {
                html += `
                <div class="card" id="card-${card.id}">
                    <div class="card-header">
                        <div class="card-title">${card.title}</div>
                        <div class="xp-display">0 / ${card.maxXP} XP</div>
                    </div>
                    <div class="progress-track"><div class="progress-fill"></div></div>
                    <div class="items">`;
                
                card.items.forEach(item => {
                    // Calculate XP for display attribute
                    let xpVal = 0;
                    if(card.scoringType === 'count_multiplier') xpVal = card.perItemXP;
                    else xpVal = item.xp || card.maxXP; // fallback
                    
                    html += `<label><input type="checkbox" data-key="${item.id}" data-card="${card.id}" data-xp="${xpVal}"> ${item.label}</label>`;
                });

                html += `</div></div>`;
            });
            html += `</div></section>`;
        });

        // 3. Daily Note
        html += `<section class="section-block"><div class="card"><div class="card-header"><div class="card-title">Daily Journal</div></div><textarea id="daily-note-area" placeholder="Wins, lessons, or thoughts..."></textarea></div></section>`;

        els.content.innerHTML = html;
        
        // Re-attach checkbox listeners
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', (e) => {
                updateVisuals();
                if(e.target.checked) showFloatingXP(e);
            });
        });
    }

    // --- CALCULATIONS ---
    function updateVisuals() {
        const state = readState();
        let totalXP = 0;

        KOMOREBI_CONFIG.protocols.forEach(section => {
            section.cards.forEach(card => {
                let cardXP = 0;
                // Logic for this card
                const checkedCount = card.items.filter(i => state[i.id]).length;

                if (card.scoringType === 'count_multiplier') {
                    // e.g. 3 items = max, 1 item = 1/3 max
                    if (checkedCount === card.items.length) cardXP = card.maxXP;
                    else cardXP = checkedCount * card.perItemXP;
                } else {
                    // Standard sum
                    card.items.forEach(i => { if(state[i.id]) cardXP += (i.xp || 0); });
                }

                // Limit check
                if (cardXP > card.maxXP) cardXP = card.maxXP;
                totalXP += cardXP;

                // Update UI Card
                const cardEl = document.getElementById(`card-${card.id}`);
                if (cardEl) {
                    cardEl.querySelector('.xp-display').innerText = `${Math.round(cardXP)} / ${card.maxXP} XP`;
                    const pct = (cardXP / card.maxXP) * 100;
                    const fill = cardEl.querySelector('.progress-fill');
                    fill.style.width = `${pct}%`;
                    if(pct >= 100) fill.classList.add('maxed'); else fill.classList.remove('maxed');
                }
            });
        });

        // Update Global UI
        els.xpTotal.innerText = `Total: ${Math.round(totalXP)} / ${KOMOREBI_CONFIG.maxXP}`;
        els.xpPill.innerText = Math.round(totalXP);
        
        let label = "Red Zone", cls = "red";
        if (totalXP >= KOMOREBI_CONFIG.levels.elite) { label = "Elite"; cls = "elite"; }
        else if (totalXP >= KOMOREBI_CONFIG.levels.strong) { label = "Strong"; cls = "strong"; }
        else if (totalXP >= KOMOREBI_CONFIG.levels.survival) { label = "Survival"; cls = "survival"; }
        els.rating.className = `badge ${cls}`;
        els.rating.innerText = label;

        previousXP = totalXP;
    }

    // --- LIBRARY ---
    function renderLibrary() {
        const filter = document.getElementById('lib-search').value.toLowerCase();
        let data = KOMOREBI_CONFIG.library[currentLibTab] || [];
        
        // Handle simple strings (quotes) vs objects
        if(currentLibTab === 'quotes') {
            data = data.map(q => ({ name: "Quote", desc: q }));
        }

        els.libList.innerHTML = data
            .filter(i => i.name.toLowerCase().includes(filter) || (i.desc && i.desc.toLowerCase().includes(filter)))
            .map(i => `
                <div class="lib-item">
                    <div class="lib-item-title">${i.name} ${i.years ? `<span class="investor-meta">${i.years}</span>` : ''}</div>
                    <div class="lib-item-desc">${i.resource || i.desc}</div>
                </div>`
            ).join('');
    }

    function switchLibTab(tab) {
        currentLibTab = tab;
        document.querySelectorAll('.lib-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        renderLibrary();
    }

    // --- HELPERS ---
    function readState() {
        const s = {};
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => s[cb.dataset.key] = cb.checked);
        return s;
    }
    function writeState(s) {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = !!s[cb.dataset.key]);
        document.getElementById('daily-note-area').value = s.note || "";
    }
    function getFormatKey() { return `komorebi_${els.dateInput.value}`; }
    function saveDay() { 
        const s = readState(); 
        s.note = document.getElementById('daily-note-area').value;
        localStorage.setItem(getFormatKey(), JSON.stringify(s)); 
        alert("Saved."); 
    }
    function loadDay() {
        buildUI(); // Reset UI for random prompts based on date
        const raw = localStorage.getItem(getFormatKey());
        if(raw) writeState(JSON.parse(raw));
        updateVisuals();
    }
    function getRandom(arr, seed) {
        // Simple hash function for daily consistency
        let hash = 0;
        for(let i=0; i<seed.length; i++) hash = ((hash << 5) - hash) + seed.charCodeAt(i);
        return arr[Math.abs(hash) % arr.length];
    }
    function getInvestorOfTheWeek(dateStr) {
        const d = new Date(dateStr);
        const start = new Date(d.getFullYear(), 0, 1);
        const week = Math.ceil((((d - start) / 86400000) + start.getDay() + 1) / 7);
        return KOMOREBI_CONFIG.library.investors[week % KOMOREBI_CONFIG.library.investors.length];
    }
    function showFloatingXP(e) {
        const div = document.createElement('div');
        div.className = 'floating-xp';
        div.innerText = `+${e.target.dataset.xp} XP`;
        div.style.left = e.clientX + 'px';
        div.style.top = e.clientY + 'px';
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1000);
    }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function restoreData() {
        try {
            const d = JSON.parse(document.getElementById('export-area').value);
            if(confirm("Overwrite?")) { localStorage.clear(); Object.keys(d).forEach(k => localStorage.setItem(k, d[k])); loadDay(); closeModal('settings-modal'); }
        } catch(e) { alert("Invalid JSON"); }
    }

    // Run
    init();
  </script>
</body>
</html>
