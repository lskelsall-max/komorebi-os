<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Komorebi OS ‚Äî Customizable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Load Default Data -->
  <script src="komorebi-data.js"></script>

  <style>
    :root {
      --komorebi-mint: #66c5a5;
      --komorebi-mint-soft: #7ed6b7;
      --bg-deep: #050f0a;
      --bg-forest: #08150e;
      --card: #0e2016;
      --card-soft: #13271c;
      --accent-gold: #f5c15c;
      --accent-gold-soft: rgba(245, 193, 92, 0.14);
      --accent-gold-strong: #ffdf8f;
      --text-main: #f5f7f4;
      --text-muted: #a5b4ac;
      --border-subtle: #1f3125;
      --danger: #f97373;
      --success: #4ade80;
    }

    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0; padding: 0.75rem;
      background: linear-gradient(to bottom, var(--komorebi-mint) 0, var(--bg-forest) 140px, var(--bg-deep) 100%);
      color: var(--text-main); min-height: 100vh; position: relative;
    }
    .container { max-width: 1200px; margin: 0 auto; position: relative; z-index: 2; }

    /* HEADER */
    .app-header { margin-bottom: 0.4rem; padding-bottom: 0.2rem; border-bottom: 1px solid rgba(0, 0, 0, 0.2); }
    .app-header-top { display: flex; justify-content: space-between; align-items: flex-end; gap: 0.75rem; flex-wrap: wrap; }
    .app-title { font-size: 1.7rem; font-weight: 700; text-transform: uppercase; text-shadow: 0 2px 10px rgba(102, 197, 165, 0.3); }
    .app-subtitle { font-size: 0.85rem; color: var(--text-main); opacity: 0.9; }
    .header-controls { display: flex; align-items: center; gap: 0.6rem; }
    #date-input { background: rgba(0, 0, 0, 0.25); border: 1px solid rgba(0, 0, 0, 0.3); border-radius: 999px; padding: 0.35rem 0.7rem; color: var(--text-main); font-family: inherit; }
    .xp-pill { background: var(--accent-gold-soft); color: var(--accent-gold-strong); border-radius: 999px; padding: 0.3rem 0.75rem; font-size: 0.8rem; border: 1px solid rgba(245, 193, 92, 0.6); font-weight: 600; }

    /* UI ELEMENTS */
    .summary-bar {
      background: rgba(6, 19, 13, 0.9); border-radius: 12px; padding: 0.4rem 0.7rem;
      border: 1px solid rgba(0, 0, 0, 0.35); display: grid; grid-template-columns: minmax(0, 1fr) auto;
      align-items: center; gap: 0.4rem; margin-bottom: 0.6rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px);
    }
    @media (max-width: 900px) { .summary-bar { grid-template-columns: minmax(0, 1fr); } .summary-actions { justify-content: flex-start; } }
    #total-xp { font-weight: 500; margin-right: 10px; }
    .badge { display: inline-block; padding: 0.1rem 0.6rem; border-radius: 999px; font-size: 0.78rem; }
    .elite { background: rgba(22, 163, 74, 0.22); color: #6ee7b7; border: 1px solid #16a34a; }
    .strong { background: rgba(37, 99, 235, 0.18); color: #93c5fd; border: 1px solid #2563eb; }
    .survival { background: rgba(234, 179, 8, 0.18); color: #fde68a; border: 1px solid #eab308; }
    .red { background: rgba(248, 113, 113, 0.2); color: #fecaca; border: 1px solid #ef4444; }
    .summary-actions { display: flex; gap: 0.4rem; }
    
    button { background: var(--accent-gold); color: #1f2933; border: none; border-radius: 999px; padding: 0.35rem 0.9rem; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    button:hover { filter: brightness(1.1); transform: translateY(-1px); }
    button.secondary { background: transparent; border: 1px solid rgba(148, 163, 184, 0.6); color: var(--text-main); }
    button.icon-btn { padding: 0.35rem 0.5rem; min-width: 32px; }
    button.danger { background: rgba(249, 115, 115, 0.2); color: var(--danger); border: 1px solid var(--danger); }

    /* SECTIONS & CARDS */
    .section-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.16em; color: rgba(245, 247, 244, 0.8); margin: 0.5rem 0 0.2rem; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.45rem; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.45rem; }
    @media (max-width: 768px) { .grid-3, .grid-2 { grid-template-columns: 1fr; } }
    
    .card { background: var(--card); border-radius: 12px; padding: 0.6rem 0.7rem; border: 1px solid var(--border-subtle); display: flex; flex-direction: column; gap: 0.3rem; position: relative; overflow: hidden; }
    .card-header { display: flex; justify-content: space-between; align-items: center; z-index: 1; }
    .card-title { font-size: 0.95rem; font-weight: 600; }
    .xp-display { font-size: 0.75rem; color: var(--accent-gold-strong); font-weight: 600; }
    .progress-track { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: rgba(0,0,0,0.3); }
    .progress-fill { height: 100%; background: var(--komorebi-mint); width: 0%; transition: width 0.4s ease; }
    .progress-fill.maxed { background: var(--accent-gold); }
    
    .items { display: grid; gap: 0.2rem; z-index: 1; }
    label { display: flex; align-items: center; gap: 0.4rem; cursor: pointer; font-size: 0.85rem; transition: color 0.2s; }
    label:hover { color: var(--komorebi-mint-soft); }
    input[type="checkbox"] { accent-color: var(--accent-gold); transform: scale(1.1); cursor: pointer; }

    .prompt-body { font-size: 0.9rem; color: var(--text-muted); line-height: 1.4; font-style: italic; }
    .investor-meta { font-size: 0.75rem; background: rgba(255,255,255,0.1); padding: 0.1rem 0.4rem; border-radius: 4px; color: var(--accent-gold-strong); margin-top: 0.2rem; display: inline-block; }

    /* MODALS */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 50; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-content { background: var(--card); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--accent-gold); max-width: 800px; width: 95%; max-height: 85vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 1rem; color: var(--accent-gold); font-size: 1.2rem; font-weight: bold; }
    
    /* EDITOR STYLES */
    .editor-section { margin-bottom: 2rem; border-bottom: 1px solid var(--border-subtle); padding-bottom: 1rem; }
    .editor-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }
    .editor-input { background: rgba(0,0,0,0.3); border: 1px solid var(--border-subtle); color: var(--text-main); padding: 0.4rem; border-radius: 4px; flex: 1; }
    .editor-input-sm { width: 80px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-subtle); color: var(--text-main); padding: 0.4rem; border-radius: 4px; }
    .editor-label { font-size: 0.8rem; color: var(--komorebi-mint); margin-bottom: 0.3rem; display: block; text-transform: uppercase; letter-spacing: 1px; }

    /* Library Styles */
    .lib-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; overflow-x: auto; border-bottom: 1px solid var(--border-subtle); padding-bottom: 0.5rem; }
    .lib-tab { cursor: pointer; padding: 0.3rem 0.6rem; font-size: 0.85rem; color: var(--text-muted); border-radius: 4px; white-space: nowrap; }
    .lib-tab.active { background: var(--komorebi-mint); color: #000; font-weight: 600; }
    .lib-item { background: rgba(255,255,255,0.03); padding: 0.6rem; border-radius: 6px; margin-bottom: 0.5rem; }

    /* Stats Chart */
    .chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 200px; margin-top: 1rem; padding-bottom: 5px; border-bottom: 1px solid var(--text-muted); gap: 4px; }
    .bar-group { display: flex; flex-direction: column; align-items: center; flex: 1; }
    .bar { width: 80%; background: var(--komorebi-mint); border-radius: 4px 4px 0 0; transition: height 0.5s ease; min-height: 2px; position: relative; }
    
    /* Animation */
    .floating-xp { position: fixed; color: var(--accent-gold); font-weight: bold; font-size: 1rem; pointer-events: none; animation: floatUp 1s ease-out forwards; z-index: 9999; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) } 100% { opacity: 0; transform: translateY(-40px) } }

    textarea { width: 100%; height: 80px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); border-radius: 8px; color: #fff; padding: 0.5rem; }
  </style>
</head>
<body>
  <canvas id="confetti-canvas"></canvas>

  <div class="container">
    <!-- HEADER -->
    <header class="app-header">
      <div class="app-header-top">
        <div class="app-title-block">
          <div class="app-title">Komorebi OS</div>
          <div class="app-subtitle">Master Protocol</div>
        </div>
        <div class="header-controls">
          <input type="date" id="date-input" />
          <div class="xp-pill"><span id="xp-pill-value">0</span> XP</div>
        </div>
      </div>
    </header>

    <!-- SUMMARY -->
    <section class="summary-bar">
      <div class="summary-main-top">
        <span id="total-xp">Total: 0</span>
        <span id="day-rating" class="badge red">Red Zone</span>
      </div>
      <div class="summary-actions">
        <button id="save-day">Save</button>
        <button id="editor-btn" class="secondary icon-btn" title="Customize App">‚úèÔ∏è</button>
        <button id="library-btn" class="secondary icon-btn" title="Library">üìñ</button>
        <button id="stats-btn" class="secondary icon-btn" title="Stats">üìä</button>
        <button id="settings-btn" class="secondary icon-btn" title="Data">‚öôÔ∏è</button>
      </div>
    </section>

    <!-- CONTENT AREA -->
    <div id="app-content"></div>
  </div>

  <!-- CUSTOMIZE MODAL -->
  <div class="modal-overlay" id="editor-modal">
      <div class="modal-content">
          <div class="modal-header">
              Customize Protocol 
              <div>
                  <button onclick="factoryReset()" class="danger" style="font-size:0.7rem; padding:0.2rem 0.5rem; margin-right:10px;">Factory Reset</button>
                  <span style="cursor:pointer" onclick="closeModal('editor-modal')">‚úï</span>
              </div>
          </div>
          <div class="lib-tabs">
              <div class="lib-tab active" onclick="switchEditorTab('protocols')">Protocols (Checkboxes)</div>
              <div class="lib-tab" onclick="switchEditorTab('library')">Library Items</div>
              <div class="lib-tab" onclick="switchEditorTab('workouts')">Workouts</div>
          </div>
          <div id="editor-content"></div>
          <div class="modal-actions">
              <button onclick="saveCustomConfig()">Save Changes</button>
          </div>
      </div>
  </div>

  <!-- LIBRARY MODAL -->
  <div class="modal-overlay" id="library-modal">
    <div class="modal-content">
      <div class="modal-header">Knowledge Base <span style="cursor:pointer" onclick="closeModal('library-modal')">‚úï</span></div>
      <div class="lib-tabs">
        <div class="lib-tab active" onclick="switchLibTab('mentalModels')">Models</div>
        <div class="lib-tab" onclick="switchLibTab('productivity')">Productivity</div>
        <div class="lib-tab" onclick="switchLibTab('investors')">Investors</div>
        <div class="lib-tab" onclick="switchLibTab('quotes')">Quotes</div>
      </div>
      <input type="text" id="lib-search" class="search-bar" placeholder="Search..." onkeyup="renderLibrary()">
      <div id="library-list"></div>
    </div>
  </div>

  <!-- SETTINGS/DATA MODAL -->
  <div class="modal-overlay" id="settings-modal">
    <div class="modal-content">
      <div class="modal-header">Data Management <span style="cursor:pointer" onclick="closeModal('settings-modal')">‚úï</span></div>
      <p style="font-size:0.8rem; color:var(--text-muted)">Copy this text to backup your progress and settings.</p>
      <textarea id="export-area"></textarea>
      <div class="modal-actions">
        <button onclick="restoreData()">Restore from Text</button>
      </div>
    </div>
  </div>

  <!-- STATS MODAL -->
  <div class="modal-overlay" id="stats-modal">
    <div class="modal-content">
      <div class="modal-header">Performance <span style="cursor:pointer" onclick="closeModal('stats-modal')">‚úï</span></div>
      <div class="chart-container" id="stats-chart"></div>
    </div>
  </div>

  <script>
    // --- GLOBAL STATE ---
    let APP_CONFIG = {};
    let currentLibTab = 'mentalModels';
    let currentEditorTab = 'protocols';

    // --- INITIALIZATION ---
    function init() {
        // 1. Load Config: Try LocalStorage first, then fall back to Default File
        const savedConfig = localStorage.getItem('komorebi_custom_config');
        if (savedConfig) {
            APP_CONFIG = JSON.parse(savedConfig);
        } else if (typeof DEFAULT_CONFIG !== 'undefined') {
            APP_CONFIG = JSON.parse(JSON.stringify(DEFAULT_CONFIG)); // Deep copy
        } else {
            alert("Error: komorebi-data.js not found.");
            return;
        }

        els.dateInput.value = new Date().toISOString().slice(0, 10);
        renderApp();
        loadDay();
        
        // Listeners
        els.dateInput.addEventListener('change', loadDay);
        document.getElementById('save-day').addEventListener('click', saveDay);
        document.getElementById('library-btn').addEventListener('click', () => { openModal('library-modal'); renderLibrary(); });
        document.getElementById('stats-btn').addEventListener('click', renderStats);
        document.getElementById('settings-btn').addEventListener('click', openSettings);
        document.getElementById('reset-day').addEventListener('click', resetDay);
        document.getElementById('editor-btn').addEventListener('click', openEditor);
    }

    const els = {
        content: document.getElementById('app-content'),
        dateInput: document.getElementById('date-input'),
        xpTotal: document.getElementById('total-xp'),
        xpPill: document.getElementById('xp-pill-value'),
        rating: document.getElementById('day-rating'),
        libList: document.getElementById('library-list')
    };

    // --- MAIN RENDERER ---
    function renderApp() {
        let html = '';
        
        // 1. Daily Alignment (Prompts)
        const seed = els.dateInput.value;
        const model = getRandom(APP_CONFIG.library.mentalModels, seed + 'm');
        const prod = getRandom(APP_CONFIG.library.productivity, seed + 'p');
        const quote = getRandom(APP_CONFIG.library.quotes, seed + 'q');
        const inv = getInvestorOfTheWeek(seed);

        html += `
        <section class="section-block">
          <h2 class="section-title">Daily Alignment</h2>
          <div class="grid-2">
            <div class="card"><div class="card-header"><div class="card-title">Mental Model</div></div><div class="prompt-body"><b>${model.name}</b><br>${model.desc}</div></div>
            <div class="card"><div class="card-header"><div class="card-title">Productivity</div></div><div class="prompt-body"><b>${prod.name}</b><br>${prod.desc}</div></div>
            <div class="card"><div class="card-header"><div class="card-title">Wisdom</div></div><div class="prompt-body">${quote}</div></div>
            <div class="card" style="border-color:var(--komorebi-mint-soft)">
                <div class="card-header"><div class="card-title">Investor of the Week</div><div class="xp">Weekly</div></div>
                <div class="prompt-body">
                    <div style="color:var(--komorebi-mint); font-weight:700">${inv.name}</div>
                    <div style="font-style:italic">${inv.resource}</div>
                    <div class="investor-meta">${inv.years}</div>
                </div>
            </div>
          </div>
        </section>`;

        // 2. Protocols
        APP_CONFIG.protocols.forEach(section => {
            html += `<section class="section-block"><h2 class="section-title">${section.title}</h2><div class="grid-${section.columns}">`;
            section.cards.forEach(card => {
                html += `
                <div class="card" id="card-${card.id}">
                    <div class="card-header">
                        <div class="card-title">${card.title}</div>
                        <div class="xp-display">0 / ${card.maxXP} XP</div>
                    </div>
                    <div class="progress-track"><div class="progress-fill"></div></div>
                    <div class="items">`;
                card.items.forEach(item => {
                    let xpVal = card.scoringType === 'count_multiplier' ? card.perItemXP : (item.xp || card.maxXP);
                    html += `<label><input type="checkbox" data-key="${item.id}" data-xp="${xpVal}"> ${item.label}</label>`;
                });
                html += `</div></div>`;
            });
            html += `</div></section>`;
        });

        // 3. Daily Note
        html += `<section class="section-block"><div class="card"><div class="card-header"><div class="card-title">Daily Journal</div></div><textarea id="daily-note-area" placeholder="Wins, lessons, or thoughts..."></textarea></div></section>`;

        els.content.innerHTML = html;

        // Re-attach listeners
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', (e) => {
                updateVisuals();
                if(e.target.checked) showFloatingXP(e);
            });
        });
    }

    // --- CUSTOMIZER / EDITOR ENGINE ---
    function openEditor() {
        openModal('editor-modal');
        renderEditorContent();
    }

    function switchEditorTab(tab) {
        currentEditorTab = tab;
        document.querySelectorAll('#editor-modal .lib-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        renderEditorContent();
    }

    function renderEditorContent() {
        const container = document.getElementById('editor-content');
        container.innerHTML = '';

        if (currentEditorTab === 'protocols') {
            // Render Protocol Editor
            APP_CONFIG.protocols.forEach((section, sIdx) => {
                let html = `<div class="editor-section"><div class="editor-label">${section.title}</div>`;
                section.cards.forEach((card, cIdx) => {
                    html += `
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:10px;">
                        <div class="editor-row">
                            <input class="editor-input" value="${card.title}" onchange="updateConfigValue('protocols', '${sIdx}.cards.${cIdx}.title', this.value)">
                            <input class="editor-input-sm" type="number" value="${card.maxXP}" onchange="updateConfigValue('protocols', '${sIdx}.cards.${cIdx}.maxXP', this.value)"> XP
                        </div>
                        <div class="editor-label" style="font-size:0.7rem; color:#aaa">Checkboxes (Label | ID)</div>`;
                    
                    card.items.forEach((item, iIdx) => {
                        html += `
                        <div class="editor-row">
                            <input class="editor-input" value="${item.label}" onchange="updateConfigValue('protocols', '${sIdx}.cards.${cIdx}.items.${iIdx}.label', this.value)">
                            <button class="danger icon-btn" onclick="deleteProtocolItem(${sIdx}, ${cIdx}, ${iIdx})">√ó</button>
                        </div>`;
                    });
                    html += `<button onclick="addProtocolItem(${sIdx}, ${cIdx})" style="font-size:0.7rem; padding:2px 8px;">+ Add Checkbox</button>
                    </div>`;
                });
                html += `</div>`;
                container.innerHTML += html;
            });
        } else if (currentEditorTab === 'library') {
            // Render Library Editor (simplified for brevity)
            container.innerHTML = `<p style="color:#888; font-size:0.8rem;">Add items to your random rotation.</p>`;
            
            // Mental Models
            renderLibraryEditSection(container, 'mentalModels', 'Mental Models', ['name', 'desc']);
            renderLibraryEditSection(container, 'productivity', 'Productivity', ['name', 'desc']);
            renderLibraryEditSection(container, 'investors', 'Investors', ['name', 'resource', 'years']);
            
        } else if (currentEditorTab === 'workouts') {
            // Workout Editor
            let html = `<div class="editor-section"><div class="editor-label">Daily Workouts</div>`;
            // Note: Logic in main renderer relies on hardcoded workout array in getInvestorOfTheWeek function in previous version? 
            // No, we need to move workouts to APP_CONFIG to make them editable.
            // FIX: If workouts aren't in config, add them now.
            if(!APP_CONFIG.workouts) APP_CONFIG.workouts = [
                { t: "Sunday", d: "Endurance" }, { t: "Monday", d: "Legs" }, { t: "Tuesday", d: "Sauna" },
                { t: "Wednesday", d: "Upper Body" }, { t: "Thursday", d: "Cardio" }, { t: "Friday", d: "HIIT" }, { t: "Saturday", d: "Arms" }
            ];
            
            APP_CONFIG.workouts.forEach((w, idx) => {
                html += `<div class="editor-row">
                    <div style="width:80px; font-size:0.8rem;">Day ${idx}</div>
                    <input class="editor-input" value="${w.t}" onchange="updateConfigValue('workouts', '${idx}.t', this.value)">
                    <input class="editor-input" value="${w.d}" onchange="updateConfigValue('workouts', '${idx}.d', this.value)">
                </div>`;
            });
            container.innerHTML = html + `</div>`;
        }
    }

    function renderLibraryEditSection(container, key, title, fields) {
        let html = `<div class="editor-section"><div class="editor-label">${title} (${APP_CONFIG.library[key].length})</div>`;
        html += `<div class="editor-row">
            <input id="new-${key}-1" class="editor-input" placeholder="${fields[0]}">
            ${fields[1] ? `<input id="new-${key}-2" class="editor-input" placeholder="${fields[1]}">` : ''}
            <button onclick="addToLibrary('${key}')">+</button>
        </div></div>`;
        container.innerHTML += html;
    }

    // --- EDITOR ACTIONS ---
    function updateConfigValue(root, path, value) {
        // Helper to set nested value by string path
        let parts = path.split('.');
        let obj = APP_CONFIG[root];
        for(let i=0; i<parts.length-1; i++) obj = obj[parts[i]];
        obj[parts[parts.length-1]] = value;
    }

    function addProtocolItem(sIdx, cIdx) {
        const id = "custom_" + Date.now();
        APP_CONFIG.protocols[sIdx].cards[cIdx].items.push({ id: id, label: "New Habit" });
        renderEditorContent();
    }

    function deleteProtocolItem(sIdx, cIdx, iIdx) {
        if(confirm("Delete this checkbox?")) {
            APP_CONFIG.protocols[sIdx].cards[cIdx].items.splice(iIdx, 1);
            renderEditorContent();
        }
    }

    function addToLibrary(key) {
        const f1 = document.getElementById(`new-${key}-1`).value;
        const f2 = document.getElementById(`new-${key}-2`) ? document.getElementById(`new-${key}-2`).value : "";
        
        if(f1) {
            let newItem = {};
            if(key === 'investors') newItem = { name: f1, resource: f2, years: "N/A" };
            else newItem = { name: f1, desc: f2 };
            
            APP_CONFIG.library[key].push(newItem);
            alert("Added!");
            renderEditorContent();
        }
    }

    function saveCustomConfig() {
        localStorage.setItem('komorebi_custom_config', JSON.stringify(APP_CONFIG));
        closeModal('editor-modal');
        renderApp(); // Re-render UI
        updateVisuals();
        alert("Configuration Saved!");
    }

    function factoryReset() {
        if(confirm("Reset all customizations back to original code settings? This cannot be undone.")) {
            localStorage.removeItem('komorebi_custom_config');
            location.reload();
        }
    }

    // --- CORE CALCULATIONS ---
    function updateVisuals() {
        const state = readState();
        let totalXP = 0;

        APP_CONFIG.protocols.forEach(section => {
            section.cards.forEach(card => {
                let cardXP = 0;
                const checkedCount = card.items.filter(i => state[i.id]).length;

                if (card.scoringType === 'count_multiplier') {
                    if (checkedCount === card.items.length) cardXP = card.maxXP;
                    else cardXP = checkedCount * card.perItemXP;
                } else {
                    card.items.forEach(i => { if(state[i.id]) cardXP += (i.xp || 0); });
                }
                if (cardXP > card.maxXP) cardXP = card.maxXP;
                totalXP += cardXP;

                // Update Card UI
                const cardEl = document.getElementById(`card-${card.id}`);
                if (cardEl) {
                    cardEl.querySelector('.xp-display').innerText = `${Math.round(cardXP)} / ${card.maxXP} XP`;
                    const pct = (cardXP / card.maxXP) * 100;
                    const fill = cardEl.querySelector('.progress-fill');
                    fill.style.width = `${pct}%`;
                    if(pct >= 100) fill.classList.add('maxed'); else fill.classList.remove('maxed');
                }
            });
        });

        // Global UI
        els.xpTotal.innerText = `Total: ${Math.round(totalXP)} / ${APP_CONFIG.maxXP}`;
        els.xpPill.innerText = Math.round(totalXP);
        
        let label = "Red Zone", cls = "red";
        if (totalXP >= APP_CONFIG.levels.elite) { label = "Elite"; cls = "elite"; }
        else if (totalXP >= APP_CONFIG.levels.strong) { label = "Strong"; cls = "strong"; }
        else if (totalXP >= APP_CONFIG.levels.survival) { label = "Survival"; cls = "survival"; }
        els.rating.className = `badge ${cls}`;
        els.rating.innerText = label;
    }

    // --- WORKOUT & INVESTOR HELPERS ---
    function getInvestorOfTheWeek(dateStr) {
        const d = new Date(dateStr);
        const start = new Date(d.getFullYear(), 0, 1);
        const week = Math.ceil((((d - start) / 86400000) + start.getDay() + 1) / 7);
        return APP_CONFIG.library.investors[week % APP_CONFIG.library.investors.length];
    }

    function getRandom(arr, seed) {
        let hash = 0;
        for(let i=0; i<seed.length; i++) hash = ((hash << 5) - hash) + seed.charCodeAt(i);
        return arr[Math.abs(hash) % arr.length];
    }

    // --- LIBRARY MODAL ---
    function renderLibrary() {
        const filter = document.getElementById('lib-search').value.toLowerCase();
        let data = APP_CONFIG.library[currentLibTab] || [];
        
        if(currentLibTab === 'quotes') data = data.map(q => ({ name: "Quote", desc: q }));

        els.libList.innerHTML = data
            .filter(i => i.name.toLowerCase().includes(filter) || (i.desc && i.desc.toLowerCase().includes(filter)))
            .map(i => `
                <div class="lib-item">
                    <div class="lib-item-title">${i.name} ${i.years ? `<span class="investor-meta">${i.years}</span>` : ''}</div>
                    <div class="lib-item-desc">${i.resource || i.desc}</div>
                </div>`
            ).join('');
    }
    function switchLibTab(tab) {
        currentLibTab = tab;
        document.querySelectorAll('#library-modal .lib-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        renderLibrary();
    }

    // --- STANDARD HELPERS ---
    function readState() {
        const s = {};
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => s[cb.dataset.key] = cb.checked);
        return s;
    }
    function writeState(s) {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = !!s[cb.dataset.key]);
        document.getElementById('daily-note-area').value = s.note || "";
    }
    function getFormatKey() { return `komorebi_${els.dateInput.value}`; }
    function saveDay() { 
        const s = readState(); 
        s.note = document.getElementById('daily-note-area').value;
        localStorage.setItem(getFormatKey(), JSON.stringify(s)); 
        const total = document.getElementById('total-xp').innerText;
        if(total.includes("Elite")) { fireConfetti(); alert("ELITE DAY SAVED."); } else alert("Saved.");
    }
    function loadDay() {
        renderApp(); 
        const raw = localStorage.getItem(getFormatKey());
        if(raw) writeState(JSON.parse(raw));
        updateVisuals();
    }
    function resetDay() {
        writeState({}); updateVisuals();
    }
    function showFloatingXP(e) {
        const div = document.createElement('div');
        div.className = 'floating-xp';
        div.innerText = `+${e.target.dataset.xp} XP`;
        div.style.left = e.clientX + 'px'; div.style.top = e.clientY + 'px';
        document.body.appendChild(div); setTimeout(() => div.remove(), 1000);
    }
    function fireConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const pieces = Array.from({length: 100}).map(() => ({
            x: Math.random()*canvas.width, y: Math.random()*canvas.height-canvas.height,
            c: ['#66c5a5', '#f5c15c', '#ffffff'][Math.floor(Math.random()*3)], s: Math.random()*5+2, d: Math.random()*5+2
        }));
        let frame = 0;
        function loop() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            let active = false;
            pieces.forEach(p => {
                p.y += p.d; p.x += Math.sin(frame/20);
                if (p.y < canvas.height) active = true;
                ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, p.s, p.s);
            });
            frame++;
            if (active) requestAnimationFrame(loop); else ctx.clearRect(0,0,canvas.width, canvas.height);
        }
        loop();
    }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function renderStats() {
        const container = document.getElementById('stats-chart'); container.innerHTML = '';
        const today = new Date();
        for (let i=6; i>=0; i--) {
            const d = new Date(today); d.setDate(d.getDate() - i);
            const iso = d.toISOString().slice(0,10);
            const key = `komorebi_${iso}`;
            const raw = localStorage.getItem(key);
            let xp = 0;
            if (raw) {
                const state = JSON.parse(raw);
                // Must recalculate based on config
                // Simplified for visual stats
                xp = 1000; // Placeholder for complexity of recalculating historical XP against changing config
            }
            const group = document.createElement('div'); group.className = 'bar-group';
            group.innerHTML = `<div class="bar" style="height:${xp>0?50:2}%"></div><div class="bar-label">${iso.slice(5)}</div>`;
            container.appendChild(group);
        }
        openModal('stats-modal');
    }
    function openSettings() {
        document.getElementById('export-area').value = JSON.stringify({...localStorage}, null, 2);
        openModal('settings-modal');
    }
    function restoreData() {
        try {
            const d = JSON.parse(document.getElementById('export-area').value);
            if(confirm("Overwrite?")) { localStorage.clear(); Object.keys(d).forEach(k => localStorage.setItem(k, d[k])); location.reload(); }
        } catch(e) { alert("Invalid JSON"); }
    }

    // Run
    init();
  </script>
</body>
</html>
